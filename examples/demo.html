<!doctype html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>dual-scroll-sync v0.6.0</title>
    <style>
      :root {
        --bg: #1a1a2e;
        --surface: #16213e;
        --surface2: #0f3460;
        --accent: #e94560;
        --accent2: #f59e0b;
        --text: #e0e0e0;
        --text-dim: #8892a4;
        --border: #2a3a5c;
        --gutter-bg: #0d1b36;
        --fm: "Consolas", "Monaco", "Courier New", monospace;
        --fs: Georgia, "Source Serif 4", serif;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        background: var(--bg);
        color: var(--text);
        font-family: var(--fm);
        height: 100vh;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      header {
        padding: 10px 20px;
        background: var(--surface);
        border-bottom: 1px solid var(--border);
        display: flex;
        align-items: center;
        gap: 14px;
        flex-shrink: 0;
      }

      header h1 {
        font-size: 13px;
        font-weight: 600;
        color: var(--accent);
      }

      header .badge {
        font-size: 9px;
        background: var(--accent);
        color: #fff;
        padding: 2px 7px;
        border-radius: 3px;
        font-weight: 600;
      }

      header .info {
        margin-left: auto;
        font-size: 10px;
        color: var(--text-dim);
      }

      header .info span {
        color: var(--accent2);
        font-weight: 600;
      }

      .main {
        flex: 1;
        display: flex;
        overflow: hidden;
      }

      .pw {
        flex: 1;
        display: flex;
        position: relative;
        min-width: 0;
      }

      .pw + .pw {
        border-left: 1px solid var(--border);
      }

      .pl {
        position: absolute;
        top: 6px;
        left: 10px;
        font-size: 9px;
        text-transform: uppercase;
        letter-spacing: 1.5px;
        color: var(--text-dim);
        z-index: 5;
        pointer-events: none;
      }

      .pane {
        flex: 1;
        overflow-y: auto;
        padding: 28px 18px 80px;
        scroll-behavior: auto;
        min-width: 0;
      }

      .pane::-webkit-scrollbar {
        width: 5px;
      }

      .pane::-webkit-scrollbar-track {
        background: transparent;
      }

      .pane::-webkit-scrollbar-thumb {
        background: var(--border);
        border-radius: 3px;
      }

      #ind {
        width: 12px;
        flex-shrink: 0;
        background: var(--gutter-bg);
        border-left: 1px solid var(--border);
        border-right: 1px solid var(--border);
        position: relative;
        cursor: pointer;
        user-select: none;
      }

      .im {
        position: absolute;
        left: 2px;
        right: 2px;
        height: 2px;
        background: var(--accent2);
        border-radius: 1px;
        pointer-events: none;
      }

      .ic {
        position: absolute;
        left: 1px;
        right: 1px;
        height: 3px;
        background: var(--accent);
        border-radius: 2px;
        pointer-events: none;
        box-shadow: 0 0 6px var(--accent);
      }

      #ed {
        font-family: var(--fm);
        font-size: 12.5px;
        line-height: 1.65;
        white-space: pre-wrap;
        word-wrap: break-word;
        outline: none;
        color: var(--text);
        caret-color: var(--accent);
        tab-size: 2;
      }

      #pv {
        font-family: var(--fs);
        font-size: 15px;
        line-height: 1.75;
      }

      #pv h1,
      #pv h2,
      #pv h3 {
        font-family: var(--fs);
        color: var(--accent2);
        margin: 1.4em 0 0.4em;
        line-height: 1.3;
      }

      #pv h1 {
        font-size: 26px;
        border-bottom: 2px solid var(--accent);
        padding-bottom: 6px;
      }

      #pv h2 {
        font-size: 21px;
      }

      #pv h3 {
        font-size: 17px;
      }

      #pv p {
        margin: 0.7em 0;
      }

      #pv ul,
      #pv ol {
        margin: 0.7em 0 0.7em 1.4em;
      }

      #pv li {
        margin: 0.2em 0;
      }

      #pv code {
        font-family: var(--fm);
        font-size: 11.5px;
        background: var(--surface2);
        padding: 2px 5px;
        border-radius: 3px;
      }

      #pv pre {
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: 5px;
        padding: 12px;
        margin: 0.8em 0;
        overflow-x: auto;
      }

      #pv pre code {
        background: none;
        padding: 0;
        font-size: 11.5px;
        line-height: 1.55;
      }

      #pv blockquote {
        border-left: 3px solid var(--accent);
        padding-left: 12px;
        color: var(--text-dim);
        margin: 0.8em 0;
        font-style: italic;
      }

      #pv strong {
        color: #fff;
      }

      #pv em {
        color: var(--text-dim);
      }

      #pv hr {
        border: none;
        border-top: 1px solid var(--border);
        margin: 1.8em 0;
      }

      #pv table {
        border-collapse: collapse;
        margin: 0.8em 0;
        width: 100%;
      }

      #pv th,
      #pv td {
        padding: 6px 12px;
        border: 1px solid var(--border);
        text-align: left;
        font-size: 13px;
      }

      #pv th {
        background: var(--surface2);
        color: var(--accent2);
        font-weight: 600;
      }

      footer {
        padding: 6px 20px;
        background: var(--surface);
        border-top: 1px solid var(--border);
        font-size: 10px;
        color: var(--text-dim);
        display: flex;
        gap: 20px;
        flex-shrink: 0;
      }

      footer .v {
        color: var(--accent2);
        font-weight: 600;
      }

      #settings-bar {
        background: var(--surface);
        border-bottom: 1px solid var(--border);
        flex-shrink: 0;
      }

      #settings-toggle {
        display: block;
        width: 100%;
        padding: 5px 20px;
        background: none;
        border: none;
        color: var(--text-dim);
        font-family: var(--fm);
        font-size: 10px;
        text-align: left;
        cursor: pointer;
        letter-spacing: 0.5px;
      }

      #settings-toggle:hover {
        color: var(--accent2);
      }

      #settings-panel {
        display: flex;
        flex-wrap: wrap;
        gap: 12px 24px;
        padding: 8px 20px 10px;
        border-top: 1px solid var(--border);
        transition:
          max-height 0.2s ease,
          padding 0.2s ease,
          opacity 0.15s ease;
        max-height: 200px;
        opacity: 1;
        overflow: hidden;
      }

      #settings-panel.collapsed {
        max-height: 0;
        padding-top: 0;
        padding-bottom: 0;
        opacity: 0;
        border-top-color: transparent;
      }

      #settings-panel label {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 10px;
        color: var(--text-dim);
        white-space: nowrap;
      }

      #settings-panel input[type="range"] {
        width: 80px;
        height: 3px;
        accent-color: var(--accent);
        cursor: pointer;
      }

      #settings-panel span {
        color: var(--accent2);
        font-weight: 600;
        min-width: 32px;
        text-align: right;
      }
    </style>
  </head>

  <body>
    <header>
      <h1>dual-scroll-sync</h1>
      <span class="badge">v0.6.0</span>
      <div class="info">
        Anchors: <span id="sa">-</span> | vTotal: <span id="sv">-</span>px
      </div>
    </header>
    <div id="settings-bar">
      <button id="settings-toggle">&#9881; Settings</button>
      <div id="settings-panel" class="collapsed">
        <label>
          alignOffset
          <input type="range" id="opt-alignOffset" min="0" max="200" value="30" />
          <span id="val-alignOffset">30</span>px
        </label>
        <label>
          wheel.smooth
          <input
            type="range"
            id="opt-smooth"
            min="0"
            max="100"
            value="10"
            step="1"
          />
          <span id="val-smooth">0.10</span>
        </label>
        <label>
          wheel.snap
          <input type="range" id="opt-snap" min="0" max="200" value="60" />
          <span id="val-snap">60</span>px
        </label>
        <label>
          brake.factor
          <input
            type="range"
            id="opt-brakeFactor"
            min="0"
            max="100"
            value="20"
            step="1"
          />
          <span id="val-brakeFactor">0.20</span>
        </label>
        <label>
          brake.zone
          <input type="range" id="opt-brakeZone" min="0" max="300" value="80" />
          <span id="val-brakeZone">80</span>px
        </label>
      </div>
    </div>
    <div class="main">
      <div class="pw">
        <span class="pl">Editor</span>
        <div id="ep" class="pane">
          <div id="ed" contenteditable="true" spellcheck="false"></div>
        </div>
      </div>
      <div id="ind">
        <div class="ic" id="ic"></div>
      </div>
      <div class="pw">
        <span class="pl">Preview</span>
        <div id="pp" class="pane">
          <div id="pv"></div>
        </div>
      </div>
    </div>
    <footer>
      <div>A: <span class="v" id="fa">0</span>px</div>
      <div>B: <span class="v" id="fb">0</span>px</div>
      <div>V: <span class="v" id="fv">0</span>px</div>
    </footer>
    <script src="../dist/dual-scroll-sync.iife.js"></script>
    <script>
      (function () {
        var buildMap = DualScrollSync.buildMap;
        var lookup = DualScrollSync.lookup;
        var SyncClass = DualScrollSync.DualScrollSync;

        // === Markdown Parser ===

        function parseMd(src) {
          var blocks = [];
          var html = src.replace(
            /```(\w*)\n([\s\S]*?)```/g,
            function (_, lang, code) {
              var i = blocks.length;
              blocks.push(
                "<pre data-block><code>" + esc(code.trim()) + "</code></pre>",
              );
              return "\x00B" + i + "\x00";
            },
          );
          html = esc(html);
          html = html.replace(/^### (.+)$/gm, "<h3 data-heading>$1</h3>");
          html = html.replace(/^## (.+)$/gm, "<h2 data-heading>$1</h2>");
          html = html.replace(/^# (.+)$/gm, "<h1 data-heading>$1</h1>");
          html = html.replace(/\*\*(.+?)\*\*/g, "<strong>$1</strong>");
          html = html.replace(/\*(.+?)\*/g, "<em>$1</em>");
          html = html.replace(/`([^`]+)`/g, "<code>$1</code>");
          html = html.replace(/^---$/gm, "<hr data-block>");
          html = html.replace(
            /^&gt; (.+)$/gm,
            "<blockquote data-block>$1</blockquote>",
          );
          html = html.replace(
            /^(\|.+\|)\n(\|[\s\-:|]+\|)\n((?:\|.+\|\n?)+)/gm,
            function (m, hdr, sep, body) {
              var hs = hdr.split("|").filter(function (c) {
                return c.trim();
              });
              var rs = body
                .trim()
                .split("\n")
                .map(function (r) {
                  return r.split("|").filter(function (c) {
                    return c.trim();
                  });
                });
              var o =
                "<table data-block><thead><tr>" +
                hs
                  .map(function (h) {
                    return "<th>" + h.trim() + "</th>";
                  })
                  .join("") +
                "</tr></thead><tbody>";
              rs.forEach(function (r) {
                o +=
                  "<tr>" +
                  r
                    .map(function (c) {
                      return "<td>" + c.trim() + "</td>";
                    })
                    .join("") +
                  "</tr>";
              });
              return o + "</tbody></table>";
            },
          );
          html = html.replace(/^- (.+)$/gm, "<li>$1</li>");
          html = html.replace(
            /(<li>[\s\S]*?<\/li>(\s*<li>[\s\S]*?<\/li>)*)/g,
            "<ul data-block>$1</ul>",
          );
          html = html
            .split("\n")
            .map(function (l) {
              var t = l.trim();
              if (!t || /^</.test(t) || t.indexOf("\x00B") === 0) return t;
              return "<p data-block>" + t + "</p>";
            })
            .join("\n");
          html = html.replace(/\x00B(\d+)\x00/g, function (_, i) {
            return blocks[+i];
          });
          return html;
        }
        function esc(s) {
          return s
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;");
        }

        // === Anchor computation (px-based) ===

        function getAnchors(edPane, pvPane, edEl, pvEl) {
          var text = edEl.textContent;
          var lines = text.split("\n");
          var headings = pvEl.querySelectorAll("[data-heading]");

          var edRect = edPane.getBoundingClientRect();
          var pvRect = pvPane.getBoundingClientRect();

          // TreeWalker for editor char → Y
          var walker = document.createTreeWalker(edEl, NodeFilter.SHOW_TEXT);
          var nmap = [];
          var nd,
            off = 0;
          while ((nd = walker.nextNode())) {
            nmap.push({ n: nd, s: off, e: off + nd.length });
            off += nd.length;
          }

          function charY(cp) {
            for (var i = 0; i < nmap.length; i++) {
              if (cp >= nmap[i].s && cp < nmap[i].e) {
                var r = document.createRange();
                var lo = cp - nmap[i].s;
                r.setStart(nmap[i].n, lo);
                r.setEnd(nmap[i].n, Math.min(lo + 1, nmap[i].n.length));
                return (
                  r.getBoundingClientRect().top -
                  edRect.top +
                  edPane.scrollTop
                );
              }
            }
            return edPane.scrollHeight;
          }

          function elemY(el) {
            return (
              el.getBoundingClientRect().top - pvRect.top + pvPane.scrollTop
            );
          }

          var anchors = [];

          // Heading anchors (skip lines inside fenced code blocks)
          var hIdx = 0;
          var cp = 0;
          var inFence = false;
          for (var i = 0; i < lines.length; i++) {
            if (/^```/.test(lines[i])) {
              inFence = !inFence;
            } else if (
              !inFence &&
              /^#{1,3}\s/.test(lines[i]) &&
              hIdx < headings.length
            ) {
              anchors.push({
                aPx: Math.round(charY(cp)),
                bPx: Math.round(elemY(headings[hIdx])),
                snap: true,
              });
              hIdx++;
            }
            cp += lines[i].length + 1;
          }

          // Block-level anchors (table, pre) for density in sparse regions
          var pvBlocks = pvEl.querySelectorAll(
            "table[data-block], pre[data-block]",
          );
          for (var j = 0; j < pvBlocks.length; j++) {
            var block = pvBlocks[j];
            var bTop = Math.round(elemY(block));
            var bBot = Math.round(elemY(block) + block.offsetHeight);

            // Find editor position by matching content
            var snippet = block.textContent.substring(0, 40).trim();
            if (!snippet) continue;
            var idx = text.indexOf(snippet);
            if (idx < 0) continue;

            // Back up to block start
            if (block.tagName === "TABLE") {
              while (idx > 0 && text[idx - 1] !== "\n") idx--;
            } else if (block.tagName === "PRE") {
              var fence = text.lastIndexOf("```", idx);
              if (fence >= 0 && idx - fence < 200) idx = fence;
            }

            var aTop = Math.round(charY(idx));

            // Estimate editor bottom: find end of contiguous block source
            var endIdx = idx;
            if (block.tagName === "TABLE") {
              var nl = idx;
              while (nl < text.length) {
                var next = text.indexOf("\n", nl + 1);
                if (next < 0) {
                  nl = text.length;
                  break;
                }
                var nextLine = text.substring(nl + 1, next).trim();
                if (!nextLine.startsWith("|")) {
                  nl = next;
                  break;
                }
                nl = next;
              }
              endIdx = nl;
            } else if (block.tagName === "PRE") {
              var close = text.indexOf("```", idx + 3);
              endIdx = close >= 0 ? close + 3 : idx + 100;
            }
            var aBot = Math.round(charY(Math.min(text.length - 1, endIdx)));

            anchors.push({ aPx: aTop, bPx: bTop });
            if (bBot - bTop > 50) {
              anchors.push({ aPx: aBot, bPx: bBot });
            }
          }

          return anchors;
        }

        // === Sample MD ===

        var SAMPLE = [
          "# System Architecture Document",
          "",
          "This document describes a distributed data processing platform. It includes large tables, ASCII diagrams, code blocks, and dense content to stress-test scroll synchronization.",
          "",
          "## 1. System Overview",
          "",
          "The platform consists of five subsystems: ingestion, processing, storage, query, and monitoring. Each runs as an independent service cluster.",
          "",
          "Data flows from external sources through ingestion, gets transformed in processing, persisted in storage, and made available through the query layer.",
          "",
          "### 1.1 Component Diagram",
          "",
          "```",
          "+-------------------+     +--------------------+     +------------------+",
          "|                   |     |                    |     |                  |",
          "|   Data Sources    +---->+   Ingestion Layer  +---->+  Message Queue   |",
          "|                   |     |                    |     |                  |",
          "| - REST APIs       |     | - Rate limiting    |     | - Partitioned    |",
          "| - Webhooks        |     | - Schema validate  |     | - Replicated     |",
          "| - File uploads    |     | - Deduplication    |     | - Ordered        |",
          "| - Stream feeds    |     | - Format normalize |     | - Persistent     |",
          "|                   |     |                    |     |                  |",
          "+-------------------+     +--------------------+     +--------+---------+",
          "                                                              |",
          "                                                              v",
          "+-------------------+     +--------------------+     +--------+---------+",
          "|                   |     |                    |     |                  |",
          "|   Query Engine    +<----+   Storage Layer    +<----+  Processing     |",
          "|                   |     |                    |     |                  |",
          "| - SQL interface   |     | - Time-series DB   |     | - Stream proc   |",
          "| - GraphQL API     |     | - Document store   |     | - Batch proc    |",
          "| - Caching layer   |     | - Object storage   |     | - ML pipeline   |",
          "| - Access control  |     | - Search index     |     | - Aggregation   |",
          "|                   |     |                    |     |                  |",
          "+-------------------+     +--------------------+     +------------------+",
          "```",
          "",
          "### 1.2 Technology Stack",
          "",
          "| Layer | Technology | Version | Purpose | Scaling Model | SLA |",
          "|-------|-----------|---------|---------|--------------|-----|",
          '| Ingestion | Go microservices | 1.21 | HTTP/gRPC endpoints with validation and rate limiting per API key | Horizontal auto-scale 3-50 instances based on request rate | 99.99% uptime p99 < 50ms |',
          '| Queue | Apache Kafka | 3.6 | Durable message transport with exactly-once semantics and partition-level ordering guarantees | Fixed partition count with consumer group rebalancing on failure | Zero message loss, < 100ms e2e |',
          '| Processing | Apache Flink | 1.18 | Stream processing with event-time windows, watermarks, and exactly-once state snapshots | Task-level parallelism with automatic checkpoint recovery and rescaling | Lag < 5s at 1M events/sec |',
          '| Storage | PostgreSQL + S3 | 16.1 | Hot data in PG with auto-partitioning, cold data in S3 Parquet with lifecycle policies | Vertical for PG, horizontal for S3, read replicas for analytics | RPO < 1min, RTO < 5min |',
          '| Query | Trino | 433 | Federated SQL across PG, S3, and ES with cost-based optimizer and predicate pushdown | Worker auto-scale on queue depth, spot instances for batch workloads | p95 < 10s for dashboards |',
          '| Search | Elasticsearch | 8.11 | Full-text search, log analytics, metric aggregation with cross-cluster replication | Index-level sharding with automatic rebalancing across data nodes | p99 < 200ms, index lag < 30s |',
          '| Cache | Redis Cluster | 7.2 | Query caching, session storage, rate counters with hash-slot sharding and sentinel HA | Auto-failover < 10s, LRU eviction with configurable maxmemory policies | Hit ratio > 85% |',
          '| Monitor | Prometheus | 2.48 | Metrics collection, alerting rules, long-term storage via Thanos sidecar and compactor | Federation across clusters with hierarchical recording rules | Scrape 15s, alert eval 30s |',
          "",
          "## 2. Data Processing Pipeline",
          "",
          "The processing layer transforms raw events into enriched, aggregated data products.",
          "",
          "### 2.1 Stream Processing Flow",
          "",
          "```",
          "Kafka: raw-events",
          "    |",
          "    v",
          "[Deserialize] --> [Validate] --> [Enrich]",
          "                                    |",
          "                    +---------------+---------------+",
          "                    |               |               |",
          "                    v               v               v",
          "             [1-min window]  [5-min window]  [Session window]",
          "                    |               |               |",
          "                    v               v               v",
          '             [Sink: PG]      [Sink: ES]      [Sink: S3]',
          "```",
          "",
          "### 2.2 Enrichment Rules",
          "",
          "| Rule | Input | Lookup Source | Output | Cache TTL | Fallback |",
          "|------|-------|-------------|--------|-----------|----------|",
          '| Geo-IP | source_ip | MaxMind GeoIP2 database updated weekly with city-level accuracy and confidence scoring for 99.8% of IPv4 and 95% of IPv6 addresses | geo_country, geo_city, geo_lat, geo_lon, geo_accuracy | 24h in Redis keyed by /24 subnet, bulk refresh on DB update | Last known location or unknown with low confidence |',
          '| User Agent | ua_string | Custom pattern library with 15,000 rules covering browsers, bots, mobile apps, IoT devices, and embedded webviews across all major platforms | device_type, browser, browser_ver, os, os_ver, is_bot, is_crawler | 1h keyed by MD5(ua_string), ~2M unique entries in steady state | Basic regex parse, mark unrecognized |',
          '| Company | email_domain | Clearbit API + local PG cache of 2M+ company records with industry classification, employee count ranges, revenue estimates, and tech stack | company_name, industry, size_range, revenue_range, tech_stack[] | 30d in PG, API fallback on miss with exponential backoff and circuit breaker | Skip enrichment, mark unresolved |',
          '| Threat | source_ip, url | AbuseIPDB + VirusTotal + internal blocklist aggregated from 12 threat intelligence feeds with daily reconciliation and deduplication | threat_score 0-100, categories[], is_malicious, first_seen, report_count | 6h for IP, 24h for URL, with background refresh for high-threat entries | Neutral score 50, flag for review |',
          '| Revenue | user_id | Internal billing system with real-time subscription status, historical MRR, expansion/contraction tracking, and churn risk scoring | plan_tier, mrr_cents, lifetime_value, churn_risk, last_activity | 5min for active users, 1h for inactive, invalidated on billing events | Lookup from daily snapshot table |',
          "",
          "## 3. Database Schema",
          "",
          "### 3.1 Events Table (Hot Storage)",
          "",
          "```sql",
          "CREATE TABLE events (",
          "    id              BIGINT GENERATED ALWAYS AS IDENTITY,",
          "    event_id        UUID NOT NULL DEFAULT gen_random_uuid(),",
          "    received_at     TIMESTAMPTZ NOT NULL DEFAULT now(),",
          "    event_type      TEXT NOT NULL,",
          "    source          TEXT NOT NULL,",
          "    payload         JSONB NOT NULL,",
          "    geo_country     TEXT,",
          "    geo_city        TEXT,",
          "    device_type     TEXT,",
          "    threat_score    SMALLINT DEFAULT 0,",
          "    PRIMARY KEY (id, received_at)",
          ") PARTITION BY RANGE (received_at);",
          "CREATE INDEX idx_events_type ON events (event_type, received_at);",
          "CREATE INDEX idx_events_source ON events (source, received_at);",
          "```",
          "",
          "### 3.2 Data Lifecycle",
          "",
          "| Age | Storage | Format | Compression | Access Pattern | Retention Policy |",
          "|-----|---------|--------|------------|---------------|-----------------|",
          '| 0-7d | PostgreSQL NVMe SSD, 3-node HA with sync replication and daily PITR backups to S3 | Row-based with TOAST for JSONB, daily partitions | LZ4 for TOAST columns, zstd for WAL | Point lookups < 1ms, range scans < 50ms | Always hot, 4h backup cycle |',
          '| 7-90d | S3 Standard with cross-region replication, versioning, and integrity checksums | Apache Parquet with Snappy compression, partitioned by date/type/source | Snappy block compression ~3:1, dictionary encoding for strings | Trino federated queries, typical latency 5-30s | On-demand via Trino |',
          '| 90d-1y | S3 Infrequent Access with lifecycle transition, integrity audit monthly | Parquet with zstd compression, yearly partitions merged from daily files | Zstandard level 3 ~5:1 ratio | Quarterly compliance reports, incident investigation | Available within 12h |',
          '| 1y+ | Glacier Deep Archive with vault lock for immutability, cross-account backup | ORC format with maximum compression, yearly archives | Zstandard level 19 ~15:1 for event data | Annual audit and regulatory compliance | 48h retrieval |',
          "",
          "## 4. Monitoring Dashboard",
          "",
          "```",
          "+================================================================+",
          "|  PLATFORM HEALTH                     2024-01-15 14:30 UTC      |",
          "+================================================================+",
          "|  Ingestion    [================----]  847K/min  (85% capacity) |",
          "|  Proc. Lag    [==------------------]  2.1 sec   (OK)           |",
          "|  Queue        [====----------------]  1.2M msgs (20% depth)    |",
          "|  Storage      [============--------]  14.2 TB   (60% used)     |",
          "|  Query p95    [======--------------]  3.2 sec   (within SLA)   |",
          "|  Errors       [=-------------------]  0.02%     (nominal)      |",
          "|  Cache Hit    [=================---]  89%       (target: 85%)  |",
          "+================================================================+",
          "```",
          "",
          "### 4.1 Alert Configuration",
          "",
          "| Alert | Condition | Severity | Action |",
          "|-------|----------|----------|--------|",
          '| Error spike | error_rate > 1% sustained for 5 minutes across all ingestion pods | Critical / PagerDuty | Auto-scale ingestion +50%, page on-call |',
          '| Processing lag | flink_watermark_lag > 30s on any operator in the main pipeline | Warning / Slack | Increase parallelism, trigger savepoint |',
          '| Disk pressure | pg_data_usage > 80% on any node including WAL and temp files | Warning / Slack | Emergency partition cleanup, alert DBA |',
          '| Replication lag | pg_replication_lag > 10s on any replica measured by WAL LSN delta | Critical / PagerDuty | Pause read traffic to lagging replica |',
          "",
          "## 5. Infrastructure Layout",
          "",
          "```",
          "Region: us-east-1",
          "|",
          "+-- AZ-a",
          "|   +-- k8s-node-01 (m5.4xl) : ingestion x4, processing x2",
          "|   +-- k8s-node-02 (m5.4xl) : ingestion x4, query x2",
          "|   +-- pg-primary  (r6g.2xl) : PostgreSQL primary (sync)",
          "|   +-- redis-01    (r6g.xl)  : slots 0-5460",
          "|   +-- kafka-01    (m5.2xl)  : broker 1, partitions 0-99",
          "|",
          "+-- AZ-b",
          "|   +-- k8s-node-03 (m5.4xl) : ingestion x4, processing x2",
          "|   +-- k8s-node-04 (m5.4xl) : query x4",
          "|   +-- pg-replica-1 (r6g.2xl) : sync replica",
          "|   +-- redis-02    (r6g.xl)  : slots 5461-10922",
          "|   +-- kafka-02    (m5.2xl)  : broker 2",
          "|",
          "+-- AZ-c",
          "    +-- k8s-node-05 (m5.4xl) : processing x4, monitoring",
          "    +-- pg-replica-2 (r6g.2xl) : async replica (analytics)",
          "    +-- redis-03    (r6g.xl)  : slots 10923-16383",
          "    +-- kafka-03    (m5.2xl)  : broker 3",
          "```",
          "",
          "## 6. Cost and Recovery",
          "",
          "| Category | Monthly | % | Notes |",
          "|----------|---------|---|-------|",
          "| Compute (EC2) | $18,500 | 37% | 60% reserved, 30% on-demand, 10% spot |",
          "| Storage (S3+EBS) | $12,300 | 25% | S3 lifecycle saves 60% on warm/cold |",
          "| Database (RDS) | $8,200 | 16% | Multi-AZ PG with provisioned IOPS |",
          "| Network | $4,100 | 8% | Cross-AZ replication dominates |",
          "| Managed | $3,800 | 8% | ES, monitoring, DNS, ALB |",
          "| Other | $3,100 | 6% | Backups, CI/CD, dev envs |",
          "| **Total** | **$50,000** | **100%** | **$0.60 per 1M events** |",
          "",
          "- **RPO**: < 1 min (PG sync), < 5 min (S3 cross-region), < 30s (Kafka MirrorMaker2)",
          "- **RTO**: < 15 min including DNS propagation and health verification",
          "",
          "---",
          "",
          "*Edit this document to test scroll sync. Add headings, tables, code blocks. Anchors rebuild automatically.*",
        ].join("\n");

        // === DOM ===

        var ep = document.getElementById("ep");
        var pp = document.getElementById("pp");
        var edEl = document.getElementById("ed");
        var pvEl = document.getElementById("pv");
        var ind = document.getElementById("ind");
        var ic = document.getElementById("ic");

        edEl.textContent = SAMPLE;
        function render() {
          pvEl.innerHTML = parseMd(edEl.textContent);
        }
        render();

        // Wait for layout
        setTimeout(function () {
          var markers = [];
          var dragging = false;

          function updateInd(d) {
            markers.forEach(function (m) {
              m.remove();
            });
            markers = [];
            var m = d.segments,
              vt = d.vTotal;
            for (var i = 0; i < m.length; i++) {
              var el = document.createElement("div");
              el.className = "im";
              el.style.top = (vt > 0 ? (m[i].vPx / vt) * 100 : 0) + "%";
              ind.appendChild(el);
              markers.push(el);
            }
            document.getElementById("sa").textContent = m.length;
            document.getElementById("sv").textContent = Math.round(vt);
          }

          var sync = new SyncClass(ep, pp, {
            getAnchors: function () {
              return getAnchors(ep, pp, edEl, pvEl);
            },
            alignOffset: 30,
            wheel: {
              smooth: 0.1,
              snap: 60,
              brake: { factor: 0.2, zone: 80 },
            },
            onMapBuilt: function (d) {
              updateInd(d);
            },
            onSync: function () {
              document.getElementById("fa").textContent = Math.round(
                ep.scrollTop,
              );
              document.getElementById("fb").textContent = Math.round(
                pp.scrollTop,
              );
              document.getElementById("fv").textContent = Math.round(
                sync._vCurrent,
              );
              var vt = sync._data ? sync._data.vTotal : 1;
              ic.style.top =
                (vt > 0 ? (sync._vCurrent / vt) * 100 : 0) + "%";
            },
          });
          sync.ensureMap();

          // Indicator click/drag
          function indClick(e) {
            var r = ind.getBoundingClientRect();
            var f = Math.max(
              0,
              Math.min(1, (e.clientY - r.top) / r.height),
            );
            var d = sync.ensureMap();
            var v = f * d.vTotal;
            sync._vCurrent = v;
            ep.scrollTop = lookup(d.segments, "vPx", "aPx", v);
            pp.scrollTop = lookup(d.segments, "vPx", "bPx", v);
            sync._expectedA = ep.scrollTop;
            sync._expectedB = pp.scrollTop;
            if (sync.onSync) sync.onSync();
          }
          ind.addEventListener("mousedown", function (e) {
            if (e.button === 0) {
              e.preventDefault();
              dragging = true;
              indClick(e);
            }
          });
          document.addEventListener("mousemove", function (e) {
            if (dragging) {
              e.preventDefault();
              indClick(e);
            }
          });
          document.addEventListener("mouseup", function () {
            dragging = false;
          });

          // === Settings panel ===

          var settingsToggle = document.getElementById("settings-toggle");
          var settingsPanel = document.getElementById("settings-panel");

          settingsToggle.addEventListener("click", function () {
            settingsPanel.classList.toggle("collapsed");
          });

          function bindSlider(id, valId, divisor, apply) {
            var slider = document.getElementById(id);
            var display = document.getElementById(valId);
            slider.addEventListener("input", function () {
              var raw = Number(slider.value);
              var val = divisor > 1 ? raw / divisor : raw;
              display.textContent =
                divisor > 1 ? val.toFixed(2) : String(val);
              apply(val);
            });
          }

          bindSlider("opt-alignOffset", "val-alignOffset", 1, function (v) {
            sync.alignOffset = v;
            sync._applyV();
          });

          bindSlider("opt-smooth", "val-smooth", 100, function (v) {
            sync.wheel.smooth = v;
          });

          bindSlider("opt-snap", "val-snap", 1, function (v) {
            sync.wheel.snap = v;
          });

          bindSlider(
            "opt-brakeFactor",
            "val-brakeFactor",
            100,
            function (v) {
              sync.wheel.brake.factor = v;
            },
          );

          bindSlider("opt-brakeZone", "val-brakeZone", 1, function (v) {
            sync.wheel.brake.zone = v;
          });

          // Edit → rebuild
          var timer;
          edEl.addEventListener("input", function () {
            clearTimeout(timer);
            timer = setTimeout(function () {
              render();
              setTimeout(function () {
                sync.invalidate();
                sync.ensureMap();
              }, 300);
            }, 500);
          });
          window.addEventListener("resize", function () {
            sync.invalidate();
            sync.ensureMap();
          });
        }, 300);
      })();
    </script>
  </body>
</html>
