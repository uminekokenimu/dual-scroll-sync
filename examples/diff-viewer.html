<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>dual-scroll-sync — Diff Viewer Example</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: system-ui, sans-serif; height: 100vh; display: flex; flex-direction: column; background: #1e1e2e; color: #cdd6f4; }
  header { padding: 12px 20px; background: #181825; border-bottom: 1px solid #313244; }
  header h1 { font-size: 16px; font-weight: 600; }
  header p { font-size: 13px; color: #a6adc8; margin-top: 4px; }
  .container { flex: 1; display: flex; overflow: hidden; }
  .pane { flex: 1; overflow-y: auto; font-family: 'SF Mono', 'Fira Code', monospace; font-size: 13px; line-height: 1.6; }
  .pane-label { padding: 6px 16px; background: #181825; font-size: 11px; color: #a6adc8; text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 1px solid #313244; position: sticky; top: 0; z-index: 1; }
  .divider { width: 2px; background: #313244; }
  .line { padding: 1px 16px; white-space: pre; min-height: 1.6em; }
  .line-num { display: inline-block; width: 40px; color: #585b70; text-align: right; margin-right: 12px; user-select: none; }
  .added { background: rgba(166, 227, 161, 0.1); color: #a6e3a1; }
  .removed { background: rgba(243, 139, 168, 0.1); color: #f38ba8; }
  .hunk-header { background: rgba(137, 180, 250, 0.1); color: #89b4fa; padding: 4px 16px; font-style: italic; }
  .spacer { background: #11111b; min-height: 1.6em; border-top: 1px dashed #313244; border-bottom: 1px dashed #313244; }
</style>
</head>
<body>

<header>
  <h1>dual-scroll-sync — Diff Viewer</h1>
  <p>Two files with matching hunks synced via anchor points at hunk boundaries.</p>
</header>

<div class="container">
  <div class="pane" id="left">
    <div class="pane-label">old.js</div>
  </div>
  <div class="divider"></div>
  <div class="pane" id="right">
    <div class="pane-label">new.js</div>
  </div>
</div>

<script type="module">
import { DualScrollSync } from '../src/index.js';

const left = document.getElementById('left');
const right = document.getElementById('right');

// ─── Generate a synthetic diff ───

function generateCode(variant) {
  const shared = [];

  // Shared header (30 lines)
  for (let i = 1; i <= 30; i++) {
    shared.push(`// Module: utils.js (line ${i})`);
  }

  const hunks = [];

  // Hunk 1: function rename + body change (left: 10 lines removed, right: 25 lines added)
  const h1Left = [
    'function calculateTotal(items) {',
    '  let sum = 0;',
    '  for (const item of items) {',
    '    sum += item.price;',
    '  }',
    '  return sum;',
    '}',
    '',
    '// Legacy helper',
    'function formatPrice(n) { return "$" + n; }',
  ];
  const h1Right = [
    'function calculateTotal(items, options = {}) {',
    '  const { currency = "USD", tax = 0 } = options;',
    '  let subtotal = 0;',
    '  let taxTotal = 0;',
    '',
    '  for (const item of items) {',
    '    const itemPrice = item.discountedPrice ?? item.price;',
    '    subtotal += itemPrice * (item.quantity || 1);',
    '  }',
    '',
    '  if (tax > 0) {',
    '    taxTotal = subtotal * (tax / 100);',
    '  }',
    '',
    '  const total = subtotal + taxTotal;',
    '',
    '  return {',
    '    subtotal,',
    '    tax: taxTotal,',
    '    total,',
    '    formatted: formatCurrency(total, currency),',
    '  };',
    '}',
    '',
    'function formatCurrency(amount, currency = "USD") {',
    '  return new Intl.NumberFormat("en-US", {',
    '    style: "currency",',
    '    currency,',
    '  }).format(amount);',
    '}',
  ];
  hunks.push({ left: h1Left, right: h1Right });

  // Shared middle (40 lines)
  const mid = [];
  for (let i = 1; i <= 40; i++) {
    mid.push(`// Shared utility code block ${i}`);
  }

  // Hunk 2: Small change (left: 3 lines, right: 8 lines)
  const h2Left = [
    'function validate(input) {',
    '  return input != null;',
    '}',
  ];
  const h2Right = [
    'function validate(input, schema) {',
    '  if (input == null) return { valid: false, error: "null input" };',
    '  if (schema) {',
    '    const errors = schema.check(input);',
    '    if (errors.length) return { valid: false, errors };',
    '  }',
    '  return { valid: true, data: input };',
    '}',
  ];
  hunks.push({ left: h2Left, right: h2Right });

  // Shared middle 2 (60 lines)
  const mid2 = [];
  for (let i = 1; i <= 60; i++) {
    mid2.push(`// Another shared section line ${i}`);
  }

  // Hunk 3: Large removal on left, small addition on right
  const h3Left = [];
  for (let i = 1; i <= 35; i++) {
    h3Left.push(`// Deprecated: old logging system line ${i}`);
  }
  const h3Right = [
    '// Logging: use structured logger',
    'import { logger } from "./logger.js";',
  ];
  hunks.push({ left: h3Left, right: h3Right });

  // Shared footer (50 lines)
  const footer = [];
  for (let i = 1; i <= 50; i++) {
    footer.push(`// Footer section line ${i}`);
  }

  return { shared, hunks, mid, mid2, footer };
}

const data = generateCode();

function renderSide(container, lines, isAdded) {
  let lineNum = 1;
  const anchors = []; // { lineNum, type: 'hunk' }

  function addLines(arr, cls) {
    for (const text of arr) {
      const div = document.createElement('div');
      div.className = 'line' + (cls ? ' ' + cls : '');
      div.innerHTML = `<span class="line-num">${lineNum}</span>${escapeHtml(text)}`;
      div.dataset.anchor = lineNum;
      container.appendChild(div);
      lineNum++;
    }
  }

  function addSpacer(count) {
    const div = document.createElement('div');
    div.className = 'spacer';
    div.style.minHeight = (count * 1.6) + 'em';
    div.innerHTML = `<span class="line-num" style="visibility:hidden">~</span> (${count} lines on other side)`;
    container.appendChild(div);
  }

  function addHunkHeader(idx) {
    const div = document.createElement('div');
    div.className = 'hunk-header';
    div.dataset.hunkAnchor = idx;
    div.textContent = `@@ Hunk ${idx + 1} @@`;
    container.appendChild(div);
    anchors.push({ el: div, hunkIdx: idx });
  }

  // Build content
  addLines(data.shared, '');

  addHunkHeader(0);
  addLines(data.hunks[0][isAdded ? 'right' : 'left'], isAdded ? 'added' : 'removed');

  addLines(data.mid, '');

  addHunkHeader(1);
  addLines(data.hunks[1][isAdded ? 'right' : 'left'], isAdded ? 'added' : 'removed');

  addLines(data.mid2, '');

  addHunkHeader(2);
  addLines(data.hunks[2][isAdded ? 'right' : 'left'], isAdded ? 'added' : 'removed');

  addLines(data.footer, '');

  return anchors;
}

function escapeHtml(s) {
  return s.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
}

const leftAnchors = renderSide(left, null, false);
const rightAnchors = renderSide(right, null, true);

// ─── Sync using hunk headers as anchor points ───

const sync = new DualScrollSync(left, right, {
  getAnchors: () => {
    const anchors = [];
    for (let i = 0; i < leftAnchors.length; i++) {
      const lEl = leftAnchors[i].el;
      const rEl = rightAnchors[i].el;
      anchors.push({
        aPx: lEl.offsetTop - left.firstElementChild.offsetHeight,
        bPx: rEl.offsetTop - right.firstElementChild.offsetHeight,
      });
    }
    return anchors;
  },
});

window.addEventListener('resize', () => sync.invalidate());
</script>
</body>
</html>
